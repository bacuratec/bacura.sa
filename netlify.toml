# ============================================
# إعدادات Netlify لتطبيق Next.js
# ============================================

[build]
  # أمر البناء - يقوم بتثبيت التبعيات وبناء المشروع
  command = "npm run build"
  
  # مجلد النشر - Next.js يبني في مجلد .next
  publish = ".next"
  
  # زيادة وقت البناء إلى 20 دقيقة (للمشاريع الكبيرة)
  timeout = 1200
  
  # عدم تخطي معالجة الملفات
  skip_processing = false
  
  # تفعيل معالجة CSS و JS لتحسين الأداء
  processing = { css = { bundle = true }, js = { bundle = true } }

[build.environment]
  # ============================================
  # إعدادات Next.js على Netlify
  # ============================================
  
  # تفعيل Next.js v5 على Netlify
  NETLIFY_NEXT_V5_ENABLED = "true"
  NEXT_PRIVATE_STANDALONE_VERIFY_IGNORE = "true"
  
  # استخدام Node.js 20
  NODE_VERSION = "20"
  
  # تحسينات npm - تثبيت أسرع
  NPM_FLAGS = "--prefer-offline --no-audit --no-fund"
  NPM_CONFIG_PRODUCTION = "false"
  NPM_CONFIG_AUDIT = "false"
  NPM_CONFIG_FUND = "false"
  
  # تحسينات Node.js - زيادة الذاكرة المتاحة
  NODE_OPTIONS = "--max-old-space-size=4096"
  
  # وضع CI لتحسين الأداء والتخزين المؤقت
  CI = "true"
  
  # تعطيل telemetry لتحسين الأداء
  NEXT_TELEMETRY_DISABLED = "1"

# ============================================
# إعادة التوجيه (Redirects)
# ============================================

# إعادة توجيه API إلى الخادم الخارجي
[[redirects]]
  from = "/api/:path*"
  to = "http://51.112.209.149:5141/api/:splat"
  status = 200
  force = true

# حماية الملفات الثابتة من إعادة التوجيه التلقائية
[[redirects]]
  from = "/robots.txt"
  to = "/robots.txt"
  status = 200

[[redirects]]
  from = "/manifest.json"
  to = "/manifest.json"
  status = 200

[[redirects]]
  from = "/sw.js"
  to = "/sw.js"
  status = 200

[[redirects]]
  from = "/offline.html"
  to = "/offline.html"
  status = 200

# ملاحظة: Next.js يتعامل مع التوجيه تلقائياً
# لا حاجة لإعادة توجيه يدوية للصفحات

# ============================================
# رؤوس HTTP (Headers)
# ============================================

# رؤوس Service Worker
[[headers]]
  for = "/sw.js"
  [headers.values]
    Cache-Control = "public, max-age=0, must-revalidate"
    Service-Worker-Allowed = "/"

# رؤوس manifest.json
[[headers]]
  for = "/manifest.json"
  [headers.values]
    Content-Type = "application/manifest+json"
    Cache-Control = "public, max-age=3600"

# رؤوس الملفات الثابتة لـ Next.js - تحسين التخزين المؤقت
[[headers]]
  for = "/_next/static/*"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"
    X-Content-Type-Options = "nosniff"
    X-Frame-Options = "DENY"
    X-XSS-Protection = "1; mode=block"

# رؤوس Chunks - تحسين التخزين المؤقت
[[headers]]
  for = "/_next/static/chunks/*"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"
    X-Content-Type-Options = "nosniff"

# رؤوس ملفات CSS
[[headers]]
  for = "/_next/static/css/*"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"
    Content-Type = "text/css; charset=utf-8"
    X-Content-Type-Options = "nosniff"

# رؤوس الصور والملفات الثابتة
[[headers]]
  for = "/*.jpg"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "/*.png"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "/*.svg"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "/*.webp"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

# رؤوس أمان عامة لجميع الصفحات
[[headers]]
  for = "/*"
  [headers.values]
    X-Frame-Options = "DENY"
    X-Content-Type-Options = "nosniff"
    X-XSS-Protection = "1; mode=block"
    Referrer-Policy = "strict-origin-when-cross-origin"
    Permissions-Policy = "geolocation=(), microphone=(), camera=()"

# ============================================
# إعدادات Functions (Serverless)
# ============================================

[functions]
  # استخدام esbuild لبناء أسرع
  node_bundler = "esbuild"
  
  # الملفات المطلوبة للـ functions
  included_files = [
    "package.json",
    "next.config.js"
  ]

# ============================================
# الإضافات (Plugins)
# ============================================

# إضافة Next.js المطلوبة للنشر على Netlify
[[plugins]]
  package = "@netlify/plugin-nextjs"
