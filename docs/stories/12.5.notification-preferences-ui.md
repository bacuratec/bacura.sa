## Status
To Do

## Story
**As a** user,
**I want** to manage my notification preferences through a user-friendly interface,
**so that** I can easily control what emails I receive.

## Acceptance Criteria
1. Create notification preferences page in user settings
2. Display all notification types with toggle switches
3. Allow setting digest mode (immediate, daily, weekly)
4. Allow setting quiet hours (from/to time)
5. Show master email enable/disable switch
6. Save preferences with visual feedback
7. Load current preferences on page load
8. Validate quiet hours input (from < to)
9. Support RTL layout for Arabic

## UI Components

### Notification Preferences Page
```jsx
// src/pages/settings/NotificationPreferences.jsx
import { useState, useEffect } from 'react';
import { supabase } from '../../lib/supabaseClient';
import { useAuth } from '../../hooks/useAuth';

export default function NotificationPreferences() {
  const { user } = useAuth();
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);
  const [preferences, setPreferences] = useState({
    email_enabled: true,
    order_updates: true,
    billing_updates: true,
    security_alerts: true,
    marketing: false,
    digest_mode: 'immediate',
    quiet_hours_from: null,
    quiet_hours_to: null
  });

  useEffect(() => {
    loadPreferences();
  }, [user]);

  async function loadPreferences() {
    try {
      const { data, error } = await supabase
        .from('notification_preferences')
        .select('*')
        .eq('user_id', user.id)
        .single();

      if (error && error.code !== 'PGRST116') {
        throw error;
      }

      if (data) {
        setPreferences(data);
      }
    } catch (error) {
      console.error('Error loading preferences:', error);
    } finally {
      setLoading(false);
    }
  }

  async function savePreferences() {
    setSaving(true);
    try {
      const { error } = await supabase
        .from('notification_preferences')
        .upsert({
          user_id: user.id,
          ...preferences,
          updated_at: new Date().toISOString()
        });

      if (error) throw error;

      // Show success message
      alert('تم حفظ التفضيلات بنجاح');
    } catch (error) {
      console.error('Error saving preferences:', error);
      alert('حدث خطأ أثناء حفظ التفضيلات');
    } finally {
      setSaving(false);
    }
  }

  function updatePreference(key, value) {
    setPreferences(prev => ({ ...prev, [key]: value }));
  }

  if (loading) {
    return <div className="loading">جاري التحميل...</div>;
  }

  return (
    <div className="notification-preferences" dir="rtl">
      <h1>إعدادات الإشعارات</h1>
      
      {/* Master Switch */}
      <div className="preference-section">
        <div className="preference-item master-switch">
          <div className="preference-info">
            <h3>تفعيل الإشعارات عبر البريد الإلكتروني</h3>
            <p>تحكم في جميع الإشعارات من مكان واحد</p>
          </div>
          <label className="toggle">
            <input
              type="checkbox"
              checked={preferences.email_enabled}
              onChange={(e) => updatePreference('email_enabled', e.target.checked)}
            />
            <span className="slider"></span>
          </label>
        </div>
      </div>

      {/* Notification Types */}
      <div className="preference-section">
        <h2>أنواع الإشعارات</h2>
        
        <div className="preference-item">
          <div className="preference-info">
            <h3>تحديثات الطلبات</h3>
            <p>احصل على إشعارات عند تحديث حالة طلباتك</p>
          </div>
          <label className="toggle">
            <input
              type="checkbox"
              checked={preferences.order_updates}
              onChange={(e) => updatePreference('order_updates', e.target.checked)}
              disabled={!preferences.email_enabled}
            />
            <span className="slider"></span>
          </label>
        </div>

        <div className="preference-item">
          <div className="preference-info">
            <h3>تحديثات الفواتير</h3>
            <p>احصل على إشعارات عند إصدار فواتير جديدة</p>
          </div>
          <label className="toggle">
            <input
              type="checkbox"
              checked={preferences.billing_updates}
              onChange={(e) => updatePreference('billing_updates', e.target.checked)}
              disabled={!preferences.email_enabled}
            />
            <span className="slider"></span>
          </label>
        </div>

        <div className="preference-item">
          <div className="preference-info">
            <h3>التنبيهات الأمنية</h3>
            <p>تنبيهات مهمة حول أمان حسابك (لا يمكن تعطيلها)</p>
          </div>
          <label className="toggle">
            <input
              type="checkbox"
              checked={true}
              disabled={true}
            />
            <span className="slider"></span>
          </label>
        </div>

        <div className="preference-item">
          <div className="preference-info">
            <h3>العروض التسويقية</h3>
            <p>احصل على آخر العروض والأخبار</p>
          </div>
          <label className="toggle">
            <input
              type="checkbox"
              checked={preferences.marketing}
              onChange={(e) => updatePreference('marketing', e.target.checked)}
              disabled={!preferences.email_enabled}
            />
            <span className="slider"></span>
          </label>
        </div>
      </div>

      {/* Digest Mode */}
      <div className="preference-section">
        <h2>وضع التجميع</h2>
        <p className="section-description">
          اختر متى تريد استلام الإشعارات
        </p>
        
        <div className="radio-group">
          <label className="radio-option">
            <input
              type="radio"
              name="digest_mode"
              value="immediate"
              checked={preferences.digest_mode === 'immediate'}
              onChange={(e) => updatePreference('digest_mode', e.target.value)}
              disabled={!preferences.email_enabled}
            />
            <div className="radio-content">
              <h4>فوري</h4>
              <p>استلم الإشعارات فور حدوثها</p>
            </div>
          </label>

          <label className="radio-option">
            <input
              type="radio"
              name="digest_mode"
              value="daily"
              checked={preferences.digest_mode === 'daily'}
              onChange={(e) => updatePreference('digest_mode', e.target.value)}
              disabled={!preferences.email_enabled}
            />
            <div className="radio-content">
              <h4>يومي</h4>
              <p>ملخص يومي لجميع الإشعارات</p>
            </div>
          </label>

          <label className="radio-option">
            <input
              type="radio"
              name="digest_mode"
              value="weekly"
              checked={preferences.digest_mode === 'weekly'}
              onChange={(e) => updatePreference('digest_mode', e.target.value)}
              disabled={!preferences.email_enabled}
            />
            <div className="radio-content">
              <h4>أسبوعي</h4>
              <p>ملخص أسبوعي لجميع الإشعارات</p>
            </div>
          </label>
        </div>
      </div>

      {/* Quiet Hours */}
      <div className="preference-section">
        <h2>ساعات الهدوء</h2>
        <p className="section-description">
          لن تستلم إشعارات خلال هذه الفترة (باستثناء التنبيهات الأمنية)
        </p>
        
        <div className="time-range">
          <div className="time-input">
            <label>من</label>
            <input
              type="time"
              value={preferences.quiet_hours_from || ''}
              onChange={(e) => updatePreference('quiet_hours_from', e.target.value)}
              disabled={!preferences.email_enabled}
            />
          </div>
          
          <div className="time-input">
            <label>إلى</label>
            <input
              type="time"
              value={preferences.quiet_hours_to || ''}
              onChange={(e) => updatePreference('quiet_hours_to', e.target.value)}
              disabled={!preferences.email_enabled}
            />
          </div>
        </div>
      </div>

      {/* Save Button */}
      <div className="actions">
        <button
          className="btn-primary"
          onClick={savePreferences}
          disabled={saving}
        >
          {saving ? 'جاري الحفظ...' : 'حفظ التفضيلات'}
        </button>
      </div>
    </div>
  );
}
```

### Styles
```css
/* src/styles/NotificationPreferences.css */
.notification-preferences {
  max-width: 800px;
  margin: 0 auto;
  padding: 2rem;
}

.notification-preferences h1 {
  font-size: 2rem;
  margin-bottom: 2rem;
  color: #1f2937;
}

.preference-section {
  background: white;
  border-radius: 12px;
  padding: 1.5rem;
  margin-bottom: 1.5rem;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.preference-section h2 {
  font-size: 1.25rem;
  margin-bottom: 0.5rem;
  color: #374151;
}

.section-description {
  color: #6b7280;
  margin-bottom: 1rem;
}

.preference-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 1rem 0;
  border-bottom: 1px solid #e5e7eb;
}

.preference-item:last-child {
  border-bottom: none;
}

.preference-item.master-switch {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 1.5rem;
  border-radius: 8px;
  margin-bottom: 1rem;
}

.preference-info h3 {
  font-size: 1rem;
  margin-bottom: 0.25rem;
}

.preference-info p {
  font-size: 0.875rem;
  color: #6b7280;
}

.master-switch .preference-info p {
  color: rgba(255, 255, 255, 0.9);
}

/* Toggle Switch */
.toggle {
  position: relative;
  display: inline-block;
  width: 52px;
  height: 28px;
}

.toggle input {
  opacity: 0;
  width: 0;
  height: 0;
}

.slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: #cbd5e1;
  transition: 0.3s;
  border-radius: 28px;
}

.slider:before {
  position: absolute;
  content: "";
  height: 20px;
  width: 20px;
  left: 4px;
  bottom: 4px;
  background-color: white;
  transition: 0.3s;
  border-radius: 50%;
}

input:checked + .slider {
  background-color: #4f46e5;
}

input:checked + .slider:before {
  transform: translateX(24px);
}

input:disabled + .slider {
  opacity: 0.5;
  cursor: not-allowed;
}

/* Radio Group */
.radio-group {
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
}

.radio-option {
  display: flex;
  align-items: center;
  padding: 1rem;
  border: 2px solid #e5e7eb;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.2s;
}

.radio-option:hover {
  border-color: #4f46e5;
  background: #f9fafb;
}

.radio-option input[type="radio"] {
  margin-left: 1rem;
}

.radio-option input[type="radio"]:checked ~ .radio-content {
  color: #4f46e5;
}

.radio-content h4 {
  font-size: 1rem;
  margin-bottom: 0.25rem;
}

.radio-content p {
  font-size: 0.875rem;
  color: #6b7280;
}

/* Time Range */
.time-range {
  display: flex;
  gap: 1rem;
}

.time-input {
  flex: 1;
}

.time-input label {
  display: block;
  margin-bottom: 0.5rem;
  font-weight: 500;
  color: #374151;
}

.time-input input[type="time"] {
  width: 100%;
  padding: 0.75rem;
  border: 2px solid #e5e7eb;
  border-radius: 8px;
  font-size: 1rem;
  transition: border-color 0.2s;
}

.time-input input[type="time"]:focus {
  outline: none;
  border-color: #4f46e5;
}

/* Actions */
.actions {
  margin-top: 2rem;
  text-align: center;
}

.btn-primary {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 0.75rem 2rem;
  border: none;
  border-radius: 8px;
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  transition: transform 0.2s;
}

.btn-primary:hover {
  transform: translateY(-2px);
}

.btn-primary:disabled {
  opacity: 0.6;
  cursor: not-allowed;
  transform: none;
}
```

## Tasks / Subtasks
- [ ] Create NotificationPreferences component
- [ ] Create CSS styles with RTL support
- [ ] Implement preference loading
- [ ] Implement preference saving with upsert
- [ ] Add form validation
- [ ] Add loading states
- [ ] Add success/error messages
- [ ] Add route to settings menu
- [ ] Test with different user states
- [ ] Add accessibility features (ARIA labels)
- [ ] Test on mobile devices

## Dev Notes
- Use `upsert` instead of `insert` to handle first-time users
- Security alerts should always be checked and disabled
- Add visual feedback for saving (toast notifications)
- Consider adding a "Test Email" button
- Add confirmation dialog for disabling all notifications
- Implement auto-save (debounced) for better UX

## Testing Checklist
- [ ] Preferences load correctly on page load
- [ ] Master switch disables all other options
- [ ] Security alerts cannot be disabled
- [ ] Quiet hours validation works
- [ ] Digest mode selection works
- [ ] Save button shows loading state
- [ ] Success message appears after save
- [ ] Error handling works correctly
- [ ] RTL layout displays correctly
- [ ] Mobile responsive design works

## Dependencies
- Story 12.1 (Notification Preferences Schema)
- Authentication system
- Supabase client
