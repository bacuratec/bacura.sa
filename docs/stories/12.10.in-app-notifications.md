## Status
To Do

## Story
**As a** user,
**I want** to receive and view notifications within the platform,
**so that** I can stay updated without checking my email.

## Acceptance Criteria
1. Display notifications in a notification center/bell icon
2. Show unread count badge
3. Mark notifications as read
4. Support different notification types with icons
5. Real-time updates using Supabase Realtime
6. Notification list with pagination
7. Click notification to navigate to relevant page
8. Delete/archive notifications
9. RTL support for Arabic

## Database Schema

### In-App Notifications Table

```sql
-- Create in_app_notifications table
create table if not exists public.in_app_notifications (
  id uuid primary key default gen_random_uuid(),
  user_id uuid not null references auth.users(id) on delete cascade,
  type text not null check (type in ('order_update', 'billing', 'security', 'system', 'message')),
  title text not null,
  body text not null,
  icon text null, -- Icon name or emoji
  link text null, -- URL to navigate to
  read boolean not null default false,
  archived boolean not null default false,
  metadata jsonb null, -- Additional data
  created_at timestamptz not null default now(),
  read_at timestamptz null
);

-- Indexes
create index idx_in_app_notifications_user_id on public.in_app_notifications(user_id);
create index idx_in_app_notifications_read on public.in_app_notifications(user_id, read);
create index idx_in_app_notifications_created_at on public.in_app_notifications(created_at desc);

-- Enable RLS
alter table public.in_app_notifications enable row level security;

-- RLS Policies
create policy "Users can view own notifications"
on public.in_app_notifications
for select
using (auth.uid() = user_id);

create policy "Users can update own notifications"
on public.in_app_notifications
for update
using (auth.uid() = user_id)
with check (auth.uid() = user_id);

create policy "Users can delete own notifications"
on public.in_app_notifications
for delete
using (auth.uid() = user_id);

create policy "Service role can insert notifications"
on public.in_app_notifications
for insert
with check (true);

-- Function to get unread count
create or replace function public.get_unread_notifications_count(p_user_id uuid)
returns bigint as $$
begin
  return (
    select count(*)
    from public.in_app_notifications
    where user_id = p_user_id
    and read = false
    and archived = false
  );
end;
$$ language plpgsql security definer;

-- Function to mark all as read
create or replace function public.mark_all_notifications_read(p_user_id uuid)
returns void as $$
begin
  update public.in_app_notifications
  set read = true, read_at = now()
  where user_id = p_user_id
  and read = false;
end;
$$ language plpgsql security definer;

comment on table public.in_app_notifications is 'In-app notifications for users';
```

## Backend Service

### Notification Service

```javascript
// src/services/inAppNotificationService.js
import { supabase } from '../lib/supabaseClient.js';

/**
 * Create in-app notification
 */
export async function createInAppNotification({
  userId,
  type,
  title,
  body,
  icon = null,
  link = null,
  metadata = null
}) {
  try {
    const { data, error } = await supabase
      .from('in_app_notifications')
      .insert({
        user_id: userId,
        type,
        title,
        body,
        icon,
        link,
        metadata
      })
      .select()
      .single();

    if (error) throw error;

    console.log(`In-app notification created: ${data.id}`);
    return { success: true, notification: data };

  } catch (error) {
    console.error('Error creating in-app notification:', error);
    return { success: false, error: error.message };
  }
}

/**
 * Send both email and in-app notification
 */
export async function sendDualNotification({
  userId,
  type,
  title,
  body,
  emailData,
  link = null,
  icon = null
}) {
  // Create in-app notification (always)
  await createInAppNotification({
    userId,
    type,
    title,
    body,
    icon,
    link
  });

  // Queue email notification (respects preferences)
  await sendNotificationAsync({
    userId,
    type: `${type}_updates`,
    subject: title,
    data: emailData
  });

  return { success: true };
}

/**
 * Helper: Notify order update
 */
export async function notifyOrderUpdateDual(userId, orderId, status, message) {
  const statusIcons = {
    'pending': 'â³',
    'in_progress': 'ğŸ”„',
    'completed': 'âœ…',
    'cancelled': 'âŒ'
  };

  return await sendDualNotification({
    userId,
    type: 'order_update',
    title: `ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø·Ù„Ø¨ #${orderId}`,
    body: message,
    icon: statusIcons[status] || 'ğŸ“¦',
    link: `/orders/${orderId}`,
    emailData: { orderId, status, message }
  });
}

/**
 * Helper: Notify new message
 */
export async function notifyNewMessage(userId, fromUser, projectId, messagePreview) {
  return await createInAppNotification({
    userId,
    type: 'message',
    title: `Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù…Ù† ${fromUser}`,
    body: messagePreview,
    icon: 'ğŸ’¬',
    link: `/projects/${projectId}`,
    metadata: { projectId, fromUser }
  });
}

/**
 * Helper: Notify payment received
 */
export async function notifyPaymentReceived(userId, amount, invoiceId) {
  return await sendDualNotification({
    userId,
    type: 'billing',
    title: 'ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø¯ÙØ¹Ø©',
    body: `ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø¯ÙØ¹Ø© Ø¨Ù…Ø¨Ù„Øº ${amount} Ø±ÙŠØ§Ù„`,
    icon: 'ğŸ’°',
    link: `/invoices/${invoiceId}`,
    emailData: { amount, invoiceId }
  });
}
```

## Frontend Components

### Notification Bell Component

```jsx
// src/components/NotificationBell.jsx
import { useState, useEffect } from 'react';
import { supabase } from '../lib/supabaseClient';
import { useAuth } from '../hooks/useAuth';
import NotificationDropdown from './NotificationDropdown';
import './NotificationBell.css';

export default function NotificationBell() {
  const { user } = useAuth();
  const [unreadCount, setUnreadCount] = useState(0);
  const [showDropdown, setShowDropdown] = useState(false);

  useEffect(() => {
    if (!user) return;

    // Load initial count
    loadUnreadCount();

    // Subscribe to real-time updates
    const subscription = supabase
      .channel('notifications')
      .on(
        'postgres_changes',
        {
          event: '*',
          schema: 'public',
          table: 'in_app_notifications',
          filter: `user_id=eq.${user.id}`
        },
        (payload) => {
          console.log('Notification change:', payload);
          loadUnreadCount();
        }
      )
      .subscribe();

    return () => {
      subscription.unsubscribe();
    };
  }, [user]);

  async function loadUnreadCount() {
    const { data } = await supabase
      .rpc('get_unread_notifications_count', { p_user_id: user.id });
    
    setUnreadCount(data || 0);
  }

  return (
    <div className="notification-bell">
      <button
        className="bell-button"
        onClick={() => setShowDropdown(!showDropdown)}
        aria-label="Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª"
      >
        <svg
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          strokeWidth="2"
        >
          <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9" />
          <path d="M13.73 21a2 2 0 0 1-3.46 0" />
        </svg>
        {unreadCount > 0 && (
          <span className="badge">{unreadCount > 99 ? '99+' : unreadCount}</span>
        )}
      </button>

      {showDropdown && (
        <NotificationDropdown
          onClose={() => setShowDropdown(false)}
          onCountChange={loadUnreadCount}
        />
      )}
    </div>
  );
}
```

### Notification Dropdown Component

```jsx
// src/components/NotificationDropdown.jsx
import { useState, useEffect } from 'react';
import { supabase } from '../lib/supabaseClient';
import { useAuth } from '../hooks/useAuth';
import { useNavigate } from 'react-router-dom';
import './NotificationDropdown.css';

export default function NotificationDropdown({ onClose, onCountChange }) {
  const { user } = useAuth();
  const navigate = useNavigate();
  const [notifications, setNotifications] = useState([]);
  const [loading, setLoading] = useState(true);
  const [page, setPage] = useState(0);
  const [hasMore, setHasMore] = useState(true);

  const PAGE_SIZE = 10;

  useEffect(() => {
    loadNotifications();
  }, [page]);

  async function loadNotifications() {
    setLoading(true);
    try {
      const { data, error } = await supabase
        .from('in_app_notifications')
        .select('*')
        .eq('user_id', user.id)
        .eq('archived', false)
        .order('created_at', { ascending: false })
        .range(page * PAGE_SIZE, (page + 1) * PAGE_SIZE - 1);

      if (error) throw error;

      setNotifications(prev => page === 0 ? data : [...prev, ...data]);
      setHasMore(data.length === PAGE_SIZE);

    } catch (error) {
      console.error('Error loading notifications:', error);
    } finally {
      setLoading(false);
    }
  }

  async function markAsRead(notificationId) {
    try {
      await supabase
        .from('in_app_notifications')
        .update({ read: true, read_at: new Date().toISOString() })
        .eq('id', notificationId);

      setNotifications(prev =>
        prev.map(n => n.id === notificationId ? { ...n, read: true } : n)
      );
      onCountChange();

    } catch (error) {
      console.error('Error marking as read:', error);
    }
  }

  async function markAllAsRead() {
    try {
      await supabase.rpc('mark_all_notifications_read', { p_user_id: user.id });
      
      setNotifications(prev => prev.map(n => ({ ...n, read: true })));
      onCountChange();

    } catch (error) {
      console.error('Error marking all as read:', error);
    }
  }

  async function deleteNotification(notificationId) {
    try {
      await supabase
        .from('in_app_notifications')
        .delete()
        .eq('id', notificationId);

      setNotifications(prev => prev.filter(n => n.id !== notificationId));
      onCountChange();

    } catch (error) {
      console.error('Error deleting notification:', error);
    }
  }

  function handleNotificationClick(notification) {
    markAsRead(notification.id);
    
    if (notification.link) {
      navigate(notification.link);
      onClose();
    }
  }

  function getNotificationIcon(type) {
    const icons = {
      'order_update': 'ğŸ“¦',
      'billing': 'ğŸ’°',
      'security': 'ğŸ”’',
      'system': 'â„¹ï¸',
      'message': 'ğŸ’¬'
    };
    return icons[type] || 'ğŸ””';
  }

  function formatTime(timestamp) {
    const date = new Date(timestamp);
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);

    if (diffMins < 1) return 'Ø§Ù„Ø¢Ù†';
    if (diffMins < 60) return `Ù…Ù†Ø° ${diffMins} Ø¯Ù‚ÙŠÙ‚Ø©`;
    if (diffHours < 24) return `Ù…Ù†Ø° ${diffHours} Ø³Ø§Ø¹Ø©`;
    if (diffDays < 7) return `Ù…Ù†Ø° ${diffDays} ÙŠÙˆÙ…`;
    return date.toLocaleDateString('ar-SA');
  }

  return (
    <div className="notification-dropdown" dir="rtl">
      <div className="dropdown-header">
        <h3>Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</h3>
        {notifications.some(n => !n.read) && (
          <button className="mark-all-read" onClick={markAllAsRead}>
            ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„ ÙƒÙ…Ù‚Ø±ÙˆØ¡
          </button>
        )}
      </div>

      <div className="notifications-list">
        {loading && page === 0 ? (
          <div className="loading">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
        ) : notifications.length === 0 ? (
          <div className="empty-state">
            <span className="empty-icon">ğŸ””</span>
            <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</p>
          </div>
        ) : (
          <>
            {notifications.map(notification => (
              <div
                key={notification.id}
                className={`notification-item ${!notification.read ? 'unread' : ''}`}
                onClick={() => handleNotificationClick(notification)}
              >
                <div className="notification-icon">
                  {notification.icon || getNotificationIcon(notification.type)}
                </div>
                <div className="notification-content">
                  <h4>{notification.title}</h4>
                  <p>{notification.body}</p>
                  <span className="notification-time">
                    {formatTime(notification.created_at)}
                  </span>
                </div>
                <button
                  className="delete-btn"
                  onClick={(e) => {
                    e.stopPropagation();
                    deleteNotification(notification.id);
                  }}
                  aria-label="Ø­Ø°Ù"
                >
                  Ã—
                </button>
              </div>
            ))}

            {hasMore && (
              <button
                className="load-more"
                onClick={() => setPage(p => p + 1)}
                disabled={loading}
              >
                {loading ? 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...' : 'ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø²ÙŠØ¯'}
              </button>
            )}
          </>
        )}
      </div>

      <div className="dropdown-footer">
        <button onClick={() => { navigate('/notifications'); onClose(); }}>
          Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
        </button>
      </div>
    </div>
  );
}
```

### Styles

```css
/* src/components/NotificationBell.css */
.notification-bell {
  position: relative;
}

.bell-button {
  position: relative;
  background: none;
  border: none;
  cursor: pointer;
  padding: 0.5rem;
  color: #6b7280;
  transition: color 0.2s;
}

.bell-button:hover {
  color: #4f46e5;
}

.bell-button .badge {
  position: absolute;
  top: 0;
  right: 0;
  background: #ef4444;
  color: white;
  font-size: 0.625rem;
  font-weight: 600;
  padding: 0.125rem 0.375rem;
  border-radius: 10px;
  min-width: 18px;
  text-align: center;
}

/* src/components/NotificationDropdown.css */
.notification-dropdown {
  position: absolute;
  top: calc(100% + 0.5rem);
  right: 0;
  width: 380px;
  max-height: 500px;
  background: white;
  border-radius: 12px;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
  z-index: 1000;
  display: flex;
  flex-direction: column;
}

.dropdown-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 1rem 1.25rem;
  border-bottom: 1px solid #e5e7eb;
}

.dropdown-header h3 {
  font-size: 1.125rem;
  font-weight: 600;
  margin: 0;
}

.mark-all-read {
  background: none;
  border: none;
  color: #4f46e5;
  font-size: 0.875rem;
  cursor: pointer;
  padding: 0.25rem 0.5rem;
}

.mark-all-read:hover {
  text-decoration: underline;
}

.notifications-list {
  flex: 1;
  overflow-y: auto;
  max-height: 400px;
}

.notification-item {
  display: flex;
  gap: 0.75rem;
  padding: 1rem 1.25rem;
  border-bottom: 1px solid #f3f4f6;
  cursor: pointer;
  transition: background 0.2s;
  position: relative;
}

.notification-item:hover {
  background: #f9fafb;
}

.notification-item.unread {
  background: #eff6ff;
}

.notification-item.unread::before {
  content: '';
  position: absolute;
  left: 0;
  top: 50%;
  transform: translateY(-50%);
  width: 4px;
  height: 60%;
  background: #4f46e5;
  border-radius: 0 4px 4px 0;
}

.notification-icon {
  font-size: 1.5rem;
  flex-shrink: 0;
}

.notification-content {
  flex: 1;
  min-width: 0;
}

.notification-content h4 {
  font-size: 0.875rem;
  font-weight: 600;
  margin: 0 0 0.25rem 0;
  color: #1f2937;
}

.notification-content p {
  font-size: 0.8125rem;
  color: #6b7280;
  margin: 0 0 0.25rem 0;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.notification-time {
  font-size: 0.75rem;
  color: #9ca3af;
}

.delete-btn {
  background: none;
  border: none;
  color: #9ca3af;
  font-size: 1.5rem;
  cursor: pointer;
  padding: 0;
  width: 24px;
  height: 24px;
  flex-shrink: 0;
  opacity: 0;
  transition: opacity 0.2s, color 0.2s;
}

.notification-item:hover .delete-btn {
  opacity: 1;
}

.delete-btn:hover {
  color: #ef4444;
}

.empty-state {
  text-align: center;
  padding: 3rem 1rem;
  color: #9ca3af;
}

.empty-icon {
  font-size: 3rem;
  display: block;
  margin-bottom: 0.5rem;
}

.load-more {
  width: 100%;
  padding: 0.75rem;
  background: none;
  border: none;
  color: #4f46e5;
  cursor: pointer;
  font-size: 0.875rem;
}

.load-more:hover {
  background: #f9fafb;
}

.dropdown-footer {
  padding: 0.75rem 1.25rem;
  border-top: 1px solid #e5e7eb;
}

.dropdown-footer button {
  width: 100%;
  padding: 0.5rem;
  background: none;
  border: none;
  color: #4f46e5;
  font-weight: 500;
  cursor: pointer;
  border-radius: 6px;
  transition: background 0.2s;
}

.dropdown-footer button:hover {
  background: #f3f4f6;
}

@media (max-width: 480px) {
  .notification-dropdown {
    width: calc(100vw - 2rem);
    right: -1rem;
  }
}
```

## Full Notifications Page

```jsx
// src/pages/Notifications.jsx
import { useState, useEffect } from 'react';
import { supabase } from '../lib/supabaseClient';
import { useAuth } from '../hooks/useAuth';
import { useNavigate } from 'react-router-dom';
import './Notifications.css';

export default function NotificationsPage() {
  const { user } = useAuth();
  const navigate = useNavigate();
  const [notifications, setNotifications] = useState([]);
  const [filter, setFilter] = useState('all'); // all, unread, read
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    loadNotifications();
  }, [filter]);

  async function loadNotifications() {
    setLoading(true);
    try {
      let query = supabase
        .from('in_app_notifications')
        .select('*')
        .eq('user_id', user.id)
        .eq('archived', false)
        .order('created_at', { ascending: false });

      if (filter === 'unread') {
        query = query.eq('read', false);
      } else if (filter === 'read') {
        query = query.eq('read', true);
      }

      const { data, error } = await query;

      if (error) throw error;
      setNotifications(data);

    } catch (error) {
      console.error('Error loading notifications:', error);
    } finally {
      setLoading(false);
    }
  }

  return (
    <div className="notifications-page" dir="rtl">
      <div className="page-header">
        <h1>Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</h1>
        
        <div className="filter-tabs">
          <button
            className={filter === 'all' ? 'active' : ''}
            onClick={() => setFilter('all')}
          >
            Ø§Ù„ÙƒÙ„
          </button>
          <button
            className={filter === 'unread' ? 'active' : ''}
            onClick={() => setFilter('unread')}
          >
            ØºÙŠØ± Ù…Ù‚Ø±ÙˆØ¡Ø©
          </button>
          <button
            className={filter === 'read' ? 'active' : ''}
            onClick={() => setFilter('read')}
          >
            Ù…Ù‚Ø±ÙˆØ¡Ø©
          </button>
        </div>
      </div>

      <div className="notifications-container">
        {loading ? (
          <div className="loading">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
        ) : notifications.length === 0 ? (
          <div className="empty-state">
            <span className="empty-icon">ğŸ””</span>
            <h2>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</h2>
            <p>Ø³Ù†Ø±Ø³Ù„ Ù„Ùƒ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¹Ù†Ø¯ Ø­Ø¯ÙˆØ« ØªØ­Ø¯ÙŠØ«Ø§Øª Ù…Ù‡Ù…Ø©</p>
          </div>
        ) : (
          <div className="notifications-grid">
            {notifications.map(notification => (
              <NotificationCard
                key={notification.id}
                notification={notification}
                onUpdate={loadNotifications}
              />
            ))}
          </div>
        )}
      </div>
    </div>
  );
}
```

## Tasks / Subtasks
- [ ] Create in_app_notifications table
- [ ] Create RLS policies
- [ ] Create database functions
- [ ] Create NotificationBell component
- [ ] Create NotificationDropdown component
- [ ] Create full Notifications page
- [ ] Implement real-time subscriptions
- [ ] Add notification sounds (optional)
- [ ] Test on mobile devices
- [ ] Add push notification integration (future)

## Dev Notes
- Use Supabase Realtime for instant updates
- Consider adding notification sounds
- Implement notification grouping for similar events
- Add notification preferences (which types to show)
- Consider browser push notifications
- Add notification actions (approve/reject)

## Testing Checklist
- [ ] Notifications appear in real-time
- [ ] Unread count updates correctly
- [ ] Mark as read works
- [ ] Delete works
- [ ] Pagination works
- [ ] Real-time subscription works
- [ ] Mobile responsive
- [ ] RTL layout correct
- [ ] Performance acceptable with many notifications

## Dependencies
- @supabase/supabase-js (Realtime)
- react-router-dom
