## Status
To Do

## Story
**As a** system,
**I want** to send emails via Zoho SMTP,
**so that** users receive reliable email notifications.

## Acceptance Criteria
1. Configure Nodemailer with Zoho SMTP settings
2. Use environment variables for credentials
3. Support HTML and plain text email templates
4. Handle SMTP errors gracefully
5. Log all sending attempts
6. Support email attachments (optional)

## Configuration

### Environment Variables
```env
# Zoho SMTP Configuration
ZOHO_SMTP_HOST=smtp.zoho.com
ZOHO_SMTP_PORT=465
ZOHO_SMTP_SECURE=true
ZOHO_SMTP_USER=info@bacuratec.com
ZOHO_SMTP_PASS=20Bac30@
ZOHO_FROM_EMAIL=info@bacuratec.com
ZOHO_FROM_NAME=Bacura Platform
```

### Nodemailer Setup
```javascript
// src/services/emailService.js
import nodemailer from "nodemailer";

// Create reusable transporter
const transporter = nodemailer.createTransport({
  host: process.env.ZOHO_SMTP_HOST || "smtp.zoho.com",
  port: parseInt(process.env.ZOHO_SMTP_PORT) || 465,
  secure: process.env.ZOHO_SMTP_SECURE === 'true', // true for 465, false for other ports
  auth: {
    user: process.env.ZOHO_SMTP_USER,
    pass: process.env.ZOHO_SMTP_PASS
  },
  // Optional: Add connection pooling for better performance
  pool: true,
  maxConnections: 5,
  maxMessages: 100
});

// Verify connection configuration
transporter.verify(function (error, success) {
  if (error) {
    console.error('SMTP connection error:', error);
  } else {
    console.log('SMTP server is ready to send emails');
  }
});

export default transporter;
```

## Email Sending Function

```javascript
// src/services/emailService.js

/**
 * Send email via Zoho SMTP
 * @param {Object} options - Email options
 * @param {string} options.to - Recipient email
 * @param {string} options.subject - Email subject
 * @param {string} options.html - HTML content
 * @param {string} options.text - Plain text content (fallback)
 * @param {Array} options.attachments - Optional attachments
 * @returns {Promise<Object>} - Send result
 */
export async function sendEmail({ to, subject, html, text, attachments = [] }) {
  try {
    const mailOptions = {
      from: {
        name: process.env.ZOHO_FROM_NAME || 'Bacura Platform',
        address: process.env.ZOHO_FROM_EMAIL || process.env.ZOHO_SMTP_USER
      },
      to,
      subject,
      html,
      text: text || stripHtml(html), // Auto-generate text from HTML if not provided
      attachments
    };

    const info = await transporter.sendMail(mailOptions);
    
    return {
      success: true,
      messageId: info.messageId,
      response: info.response,
      accepted: info.accepted,
      rejected: info.rejected
    };
  } catch (error) {
    console.error('Email sending error:', error);
    return {
      success: false,
      error: error.message,
      code: error.code
    };
  }
}

/**
 * Strip HTML tags for plain text fallback
 */
function stripHtml(html) {
  return html.replace(/<[^>]*>/g, '');
}
```

## Email Templates

```javascript
// src/templates/emailTemplates.js

export const emailTemplates = {
  orderUpdate: ({ userName, orderId, status, message }) => ({
    subject: `تحديث الطلب #${orderId}`,
    html: `
      <!DOCTYPE html>
      <html dir="rtl" lang="ar">
      <head>
        <meta charset="UTF-8">
        <style>
          body { font-family: Arial, sans-serif; direction: rtl; }
          .container { max-width: 600px; margin: 0 auto; padding: 20px; }
          .header { background: #4F46E5; color: white; padding: 20px; text-align: center; }
          .content { background: #f9fafb; padding: 20px; }
          .footer { text-align: center; padding: 20px; color: #6b7280; }
        </style>
      </head>
      <body>
        <div class="container">
          <div class="header">
            <h1>منصة باكورا</h1>
          </div>
          <div class="content">
            <h2>مرحباً ${userName}</h2>
            <p>تم تحديث حالة طلبك #${orderId}</p>
            <p><strong>الحالة الجديدة:</strong> ${status}</p>
            <p>${message}</p>
          </div>
          <div class="footer">
            <p>© 2026 منصة باكورا - جميع الحقوق محفوظة</p>
          </div>
        </div>
      </body>
      </html>
    `
  }),

  billingUpdate: ({ userName, amount, invoiceId }) => ({
    subject: `فاتورة جديدة #${invoiceId}`,
    html: `
      <!DOCTYPE html>
      <html dir="rtl" lang="ar">
      <head>
        <meta charset="UTF-8">
      </head>
      <body>
        <h2>مرحباً ${userName}</h2>
        <p>تم إصدار فاتورة جديدة بمبلغ ${amount}</p>
        <p>رقم الفاتورة: ${invoiceId}</p>
      </body>
      </html>
    `
  }),

  securityAlert: ({ userName, action, ipAddress, timestamp }) => ({
    subject: '⚠️ تنبيه أمني - نشاط غير معتاد',
    html: `
      <!DOCTYPE html>
      <html dir="rtl" lang="ar">
      <body>
        <h2>مرحباً ${userName}</h2>
        <p><strong>تم اكتشاف نشاط غير معتاد في حسابك:</strong></p>
        <ul>
          <li>الإجراء: ${action}</li>
          <li>عنوان IP: ${ipAddress}</li>
          <li>الوقت: ${timestamp}</li>
        </ul>
        <p>إذا لم تكن أنت من قام بهذا الإجراء، يرجى تغيير كلمة المرور فوراً.</p>
      </body>
      </html>
    `
  })
};
```

## Tasks / Subtasks
- [ ] Install Nodemailer package (`npm install nodemailer`)
- [ ] Create email service module
- [ ] Configure environment variables
- [ ] Create email templates (Arabic RTL support)
- [ ] Implement send function with error handling
- [ ] Test SMTP connection
- [ ] Test sending emails to different providers (Gmail, Outlook, etc.)
- [ ] Implement retry logic for failed sends
- [ ] Add email queue for bulk sending (optional)

## Dev Notes
- **Important**: Use App Password from Zoho, not the main account password
- Enable "Less Secure Apps" or create App-Specific Password in Zoho settings
- Test with different email clients to ensure compatibility
- Consider using email testing tools (Mailtrap, Ethereal) for development
- Implement rate limiting to avoid SMTP throttling
- Keep connection pool for better performance

## Security Considerations
- Never commit credentials to Git
- Use environment variables for all sensitive data
- Validate email addresses before sending
- Implement SPF, DKIM, and DMARC records for domain
- Monitor for bounce rates and spam complaints

## Testing Checklist
- [ ] SMTP connection successful
- [ ] Email sent successfully
- [ ] HTML rendering correct in different clients
- [ ] RTL (Arabic) text displays correctly
- [ ] Error handling works for invalid emails
- [ ] Retry mechanism works for temporary failures
- [ ] Email logs created correctly
- [ ] Attachments work (if implemented)

## Dependencies
- `nodemailer` package
- Zoho SMTP account with App Password
- Environment configuration
