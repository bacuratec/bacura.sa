## Status
To Do

## Story
**As a** user,
**I want** to manage my notification preferences,
**so that** I can control what emails I receive and when.

## Acceptance Criteria
1. Create `notification_preferences` table in Supabase with all required fields
2. Implement RLS policies to ensure users can only access their own preferences
3. Support different notification types: order_updates, billing_updates, security_alerts, marketing
4. Support digest modes: immediate, daily, weekly
5. Support quiet hours configuration (from/to time)
6. Auto-create default preferences for new users

## Database Schema

```sql
-- Notification Preferences Table
create table public.notification_preferences (
  user_id uuid primary key references auth.users(id) on delete cascade,
  email_enabled boolean not null default true,
  order_updates boolean not null default true,
  billing_updates boolean not null default true,
  security_alerts boolean not null default true,
  marketing boolean not null default false,
  digest_mode text not null default 'immediate' check (digest_mode in ('immediate','daily','weekly')),
  quiet_hours_from time null,
  quiet_hours_to time null,
  updated_at timestamptz not null default now()
);

-- Enable RLS
alter table public.notification_preferences enable row level security;

-- RLS Policies
create policy "Users can view own preferences"
on public.notification_preferences
for select
using (auth.uid() = user_id);

create policy "Users can upsert own preferences"
on public.notification_preferences
for insert
with check (auth.uid() = user_id);

create policy "Users can update own preferences"
on public.notification_preferences
for update
using (auth.uid() = user_id)
with check (auth.uid() = user_id);

-- Auto-create default preferences trigger
create or replace function public.create_default_notification_preferences()
returns trigger as $$
begin
  insert into public.notification_preferences (user_id)
  values (new.id)
  on conflict (user_id) do nothing;
  return new;
end;
$$ language plpgsql security definer;

create trigger on_auth_user_created_notification_prefs
  after insert on auth.users
  for each row execute function public.create_default_notification_preferences();
```

## Tasks / Subtasks
- [ ] Create migration file for `notification_preferences` table
- [ ] Apply migration to Supabase
- [ ] Create RLS policies
- [ ] Create trigger for auto-creating default preferences
- [ ] Test RLS policies with different users
- [ ] Document schema in project documentation

## Dev Notes
- Use `on conflict (user_id) do nothing` for upsert operations to prevent duplicate key errors
- Ensure `security_alerts` cannot be disabled (always true) for security reasons
- Consider adding email verification status check before sending emails
- Quiet hours should be stored in user's timezone (consider adding timezone field)

## Dependencies
- Supabase project access
- Database migration tools

## Testing Checklist
- [ ] New user automatically gets default preferences
- [ ] User can only view/edit their own preferences
- [ ] Cannot disable security_alerts
- [ ] Digest mode accepts only valid values
- [ ] Quiet hours validation (from < to)
