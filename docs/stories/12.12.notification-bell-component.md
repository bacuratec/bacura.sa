# Story 12.12: Notification Bell Component

## Status
‚úÖ Completed

## Story
**As a** user,  
**I want** a notification bell icon in the header,  
**so that** I can see unread notification count and access my notifications quickly.

## Priority
High

## Complexity
6/10

## Estimated Time
3-4 hours

## Description
Create a notification bell component that displays unread count, updates in real-time, and provides quick access to notifications.

---

## Acceptance Criteria

1. ‚úÖ Bell icon displays in header/navbar
2. ‚úÖ Badge shows unread notification count
3. ‚úÖ Real-time updates using Supabase Realtime
4. ‚úÖ Click opens notification dropdown
5. ‚úÖ Responsive design (mobile & desktop)
6. ‚úÖ RTL support
7. ‚úÖ Smooth animations
8. ‚úÖ Accessible (ARIA labels)

---

## Technical Implementation

### Component Structure

**File**: `src/components/NotificationBell.jsx`

```jsx
import { useState, useEffect } from 'react';
import { supabase } from '../lib/supabaseClient';
import { useAuth } from '../hooks/useAuth';

export default function NotificationBell() {
  const { user } = useAuth();
  const [count, setCount] = useState(0);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    if (!user) return;

    loadCount();
    subscribeToNotifications();

    return () => {
      // Cleanup subscription
    };
  }, [user]);

  async function loadCount() {
    const { count } = await supabase
      .from('in_app_notifications')
      .select('*', { count: 'exact', head: true })
      .eq('user_id', user.id)
      .eq('read', false);

    setCount(count || 0);
    setLoading(false);
  }

  function subscribeToNotifications() {
    const subscription = supabase
      .channel('notifications')
      .on(
        'postgres_changes',
        {
          event: '*',
          schema: 'public',
          table: 'in_app_notifications',
          filter: `user_id=eq.${user.id}`
        },
        () => loadCount()
      )
      .subscribe();

    return subscription;
  }

  return (
    <div className="notification-bell">
      <button className="bell-button" aria-label="ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™">
        üîî
        {count > 0 && (
          <span className="badge">{count > 99 ? '99+' : count}</span>
        )}
      </button>
    </div>
  );
}
```

### Styling

```css
.notification-bell {
  position: relative;
  display: inline-block;
}

.bell-button {
  background: none;
  border: none;
  cursor: pointer;
  font-size: 24px;
  padding: 8px;
  position: relative;
  transition: transform 0.2s;
}

.bell-button:hover {
  transform: scale(1.1);
}

.badge {
  position: absolute;
  top: 0;
  right: 0;
  background: #ef4444;
  color: white;
  border-radius: 10px;
  padding: 2px 6px;
  font-size: 12px;
  font-weight: bold;
  min-width: 20px;
  text-align: center;
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.1); }
}
```

---

## Features

### ‚úÖ Real-time Updates

```javascript
// Supabase Realtime subscription
const subscription = supabase
  .channel('notifications')
  .on('postgres_changes', {
    event: '*', // INSERT, UPDATE, DELETE
    schema: 'public',
    table: 'in_app_notifications',
    filter: `user_id=eq.${user.id}`
  }, () => {
    // Reload count when any change occurs
    loadCount();
  })
  .subscribe();
```

### ‚úÖ Badge Display Logic

```javascript
// Show count
{count > 0 && (
  <span className="badge">
    {count > 99 ? '99+' : count}
  </span>
)}
```

### ‚úÖ Loading State

```javascript
if (loading) {
  return <div className="bell-skeleton">‚è≥</div>;
}
```

---

## Integration

### In Header/Navbar

```jsx
// src/components/Header.jsx
import NotificationBell from './NotificationBell';

export default function Header() {
  return (
    <header>
      <nav>
        <Logo />
        <Menu />
        <NotificationBell /> {/* Add here */}
        <UserMenu />
      </nav>
    </header>
  );
}
```

---

## Variants

### With Dropdown

```jsx
export default function NotificationBellWithDropdown() {
  const [isOpen, setIsOpen] = useState(false);

  return (
    <div className="notification-bell">
      <button onClick={() => setIsOpen(!isOpen)}>
        üîî
        {count > 0 && <span className="badge">{count}</span>}
      </button>
      
      {isOpen && (
        <NotificationDropdown onClose={() => setIsOpen(false)} />
      )}
    </div>
  );
}
```

### With Sound

```jsx
useEffect(() => {
  const subscription = supabase
    .channel('notifications')
    .on('postgres_changes', {
      event: 'INSERT', // Only new notifications
      schema: 'public',
      table: 'in_app_notifications',
      filter: `user_id=eq.${user.id}`
    }, () => {
      // Play notification sound
      new Audio('/notification.mp3').play();
      loadCount();
    })
    .subscribe();
}, [user]);
```

---

## Accessibility

```jsx
<button 
  className="bell-button"
  aria-label={`ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ÿå ${count} ÿ∫Ÿäÿ± ŸÖŸÇÿ±Ÿàÿ°`}
  aria-live="polite"
  aria-atomic="true"
>
  üîî
  {count > 0 && (
    <span 
      className="badge"
      aria-label={`${count} ÿ•ÿ¥ÿπÿßÿ± ÿ∫Ÿäÿ± ŸÖŸÇÿ±Ÿàÿ°`}
    >
      {count}
    </span>
  )}
</button>
```

---

## Performance Optimization

### Debounce Updates

```javascript
import { useDebounce } from '../hooks/useDebounce';

const debouncedLoadCount = useDebounce(loadCount, 500);

// In subscription
.on('postgres_changes', {}, () => {
  debouncedLoadCount(); // Debounced
})
```

### Memoization

```javascript
import { useMemo } from 'react';

const badgeText = useMemo(() => {
  return count > 99 ? '99+' : count.toString();
}, [count]);
```

---

## Testing

### Unit Tests

```javascript
import { render, screen } from '@testing-library/react';
import NotificationBell from './NotificationBell';

test('displays notification count', () => {
  render(<NotificationBell />);
  const badge = screen.getByText('5');
  expect(badge).toBeInTheDocument();
});

test('shows 99+ for counts over 99', () => {
  render(<NotificationBell count={150} />);
  const badge = screen.getByText('99+');
  expect(badge).toBeInTheDocument();
});
```

---

## Dev Notes

### Key Decisions

1. **Real-time**: Supabase Realtime for instant updates
2. **Badge**: Red color for visibility
3. **Animation**: Subtle pulse for attention
4. **Threshold**: 99+ for large counts

### Challenges Solved

1. ‚úÖ Real-time subscription cleanup
2. ‚úÖ Count accuracy with concurrent updates
3. ‚úÖ Performance with frequent updates

### Future Enhancements

- [ ] Notification preview on hover
- [ ] Mark all as read button
- [ ] Filter by type
- [ ] Notification sound toggle

---

## Related Stories

- 12.10 - In-App Notifications (parent story)
- 12.13 - Notification Dropdown (next)
- 12.14 - Notifications Page (full view)

---

## Dependencies

```json
{
  "@supabase/supabase-js": "^2.x",
  "react": "^18.x"
}
```

---

## Completion Date
2026-01-06

## Notes
This component is part of the in-app notifications system (Story 12.10) and works with the notification dropdown and full notifications page.
