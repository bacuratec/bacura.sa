# Story 12.11: Edge Functions Integration

## Status
✅ Completed

## Story
**As a** platform administrator,  
**I want** automatic notifications using Supabase Edge Functions,  
**so that** I don't need to manage servers and the system scales automatically.

## Priority
High

## Complexity
8/10

## Estimated Time
4-6 hours

## Description
Implement serverless notification system using Supabase Edge Functions for automatic, scalable, and cost-effective email notifications.

---

## Acceptance Criteria

1. ✅ Edge Function deployed to Supabase
2. ✅ Database trigger calls Edge Function on order status change
3. ✅ Edge Function checks user preferences
4. ✅ Edge Function sends email via Zoho SMTP
5. ✅ Edge Function logs to email_log table
6. ✅ Comprehensive error handling
7. ✅ RTL email templates
8. ✅ Documentation for deployment

---

## Technical Implementation

### 1. Edge Function Structure

**File**: `supabase/functions/send-order-notification/index.ts`

```typescript
import { serve } from 'https://deno.land/std@0.168.0/http/server.ts'
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'
import { SmtpClient } from "https://deno.land/x/smtp@v0.7.0/mod.ts"

// Supabase client with service role
const supabase = createClient(
  Deno.env.get('SUPABASE_URL')!,
  Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')!
)

// SMTP Configuration
const SMTP_CONFIG = {
  hostname: "smtp.zoho.com",
  port: 465,
  username: Deno.env.get('ZOHO_SMTP_USER'),
  password: Deno.env.get('ZOHO_SMTP_PASS'),
}

serve(async (req) => {
  // Implementation details in actual file
})
```

### 2. Database Trigger

**File**: `database/migrations/edge_function_triggers.sql`

```sql
create or replace function public.notify_order_update_via_edge_function()
returns trigger as $$
declare
  v_supabase_url text := 'https://YOUR_PROJECT.supabase.co';
  v_anon_key text := 'YOUR_ANON_KEY';
begin
  if OLD.status is distinct from NEW.status then
    perform net.http_post(
      url := v_supabase_url || '/functions/v1/send-order-notification',
      headers := jsonb_build_object(
        'Content-Type', 'application/json',
        'Authorization', 'Bearer ' || v_anon_key
      ),
      body := jsonb_build_object('record', row_to_json(NEW))
    );
  end if;
  return NEW;
end;
$$ language plpgsql security definer;
```

### 3. Environment Variables

Required in Supabase Edge Functions settings:

```env
ZOHO_SMTP_USER=info@bacuratec.com
ZOHO_SMTP_PASS=20Bac30@
SUPABASE_URL=https://your-project.supabase.co
SUPABASE_SERVICE_ROLE_KEY=your-service-role-key
```

---

## Features

### ✅ Implemented

1. **Preference Checking**
   - Fetches user notification preferences
   - Respects email_enabled and order_updates settings
   - Skips if disabled

2. **Email Sending**
   - SMTP integration with Zoho
   - RTL HTML templates
   - Status-specific emojis and messages

3. **Logging**
   - Records all attempts in email_log
   - Tracks success/failure
   - Stores error messages

4. **Error Handling**
   - Try-catch blocks
   - Graceful degradation
   - Detailed error messages

---

## Deployment

### 1. Install Supabase CLI

```bash
npm install -g supabase
supabase login
```

### 2. Link Project

```bash
supabase link --project-ref YOUR_PROJECT_REF
```

### 3. Deploy Function

```bash
supabase functions deploy send-order-notification
```

### 4. Set Environment Variables

In Supabase Dashboard → Edge Functions → Settings

### 5. Execute Database Trigger

Run `edge_function_triggers.sql` after updating values

---

## Testing

### Test Edge Function Directly

```bash
curl -i --location --request POST \
  'https://YOUR_PROJECT.supabase.co/functions/v1/send-order-notification' \
  --header 'Authorization: Bearer YOUR_ANON_KEY' \
  --header 'Content-Type: application/json' \
  --data '{"record":{"id":"test","user_id":"USER_ID","status":"completed"}}'
```

### Test via Order Update

```javascript
await supabase
  .from('orders')
  .update({ status: 'completed' })
  .eq('id', 'order-id')
```

---

## Monitoring

### View Logs

```bash
# Via CLI
supabase functions logs send-order-notification

# Via Dashboard
Edge Functions → send-order-notification → Logs
```

### Check Status

```sql
-- Recent notifications
select * from email_log 
order by created_at desc 
limit 10;

-- Success rate
select 
  count(*) filter (where status = 'sent') as sent,
  count(*) filter (where status = 'failed') as failed
from email_log
where created_at > now() - interval '24 hours';
```

---

## Advantages

### vs Worker (Node.js)

| Feature | Edge Functions | Worker |
|---------|---------------|--------|
| Cost | Free (500K/month) | $6/month (VPS) |
| Maintenance | Zero | Manual |
| Scaling | Automatic | Manual |
| Speed | Instant | 5 second polling |
| Infrastructure | Serverless | Requires server |

---

## Dev Notes

### Key Decisions

1. **Deno vs Node.js**: Chose Deno for serverless compatibility
2. **SMTP Library**: Used `deno.land/x/smtp` for Deno compatibility
3. **Trigger Method**: Database trigger with HTTP POST for reliability
4. **Error Handling**: Comprehensive try-catch with logging

### Challenges Solved

1. ✅ Database settings permissions → Used hardcoded values in function
2. ✅ SMTP in Deno → Found compatible SMTP library
3. ✅ Service Role Key → Stored in environment variables

### Future Enhancements

- [ ] Retry logic for failed emails
- [ ] Rate limiting per user
- [ ] Email templates from database
- [ ] Multiple notification types in one function

---

## Documentation

- ✅ `docs/EDGE_FUNCTIONS_GUIDE.md` - Complete setup guide
- ✅ `docs/EDGE_FUNCTION_SETUP.md` - Quick setup
- ✅ `docs/EDGE_VS_WORKER_COMPARISON.md` - Comparison

---

## Dependencies

```json
{
  "deno": "^1.x",
  "supabase-cli": "^1.x"
}
```

### Deno Imports

- `https://deno.land/std@0.168.0/http/server.ts`
- `https://esm.sh/@supabase/supabase-js@2`
- `https://deno.land/x/smtp@v0.7.0/mod.ts`

---

## Related Stories

- 12.1 - Notification Preferences Schema
- 12.2 - Email Delivery Logging
- 12.3 - Zoho SMTP Integration
- 12.9 - Email Queue Worker (alternative approach)

---

## Completion Date
2026-01-06

## Notes
This is the **recommended approach** for most projects due to zero maintenance and automatic scaling.
