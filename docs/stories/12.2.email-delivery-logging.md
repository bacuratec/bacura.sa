## Status
To Do

## Story
**As a** system administrator,
**I want** to track all email delivery attempts,
**so that** I can monitor delivery success, prevent duplicates, and debug failures.

## Acceptance Criteria
1. Create `email_log` table to track all email sending attempts
2. Record email status: queued, sent, failed, skipped
3. Track provider responses and error messages
4. Prevent duplicate emails within a time window
5. Support retry mechanism for failed emails
6. Store metadata about email type and recipient

## Database Schema

```sql
-- Email Delivery Log Table
create table public.email_log (
  id bigserial primary key,
  user_id uuid references auth.users(id) on delete set null,
  recipient_email text not null,
  type text not null, -- order_updates / billing_updates / security_alerts / marketing
  subject text not null,
  status text not null default 'queued' check (status in ('queued','sent','failed','skipped')),
  error_text text null,
  attempts int not null default 0,
  provider text not null default 'zoho_smtp',
  provider_response text null,
  created_at timestamptz not null default now(),
  sent_at timestamptz null
);

-- Indexes for performance
create index idx_email_log_user_id on public.email_log(user_id);
create index idx_email_log_status on public.email_log(status);
create index idx_email_log_created_at on public.email_log(created_at);
create index idx_email_log_type on public.email_log(type);

-- Enable RLS (admin only access)
alter table public.email_log enable row level security;

-- Admin can view all logs
create policy "Admins can view all email logs"
on public.email_log
for select
using (
  exists (
    select 1 from public.profiles
    where profiles.id = auth.uid()
    and profiles.role = 'admin'
  )
);

-- System can insert logs (service role)
create policy "Service role can insert email logs"
on public.email_log
for insert
with check (true);

-- Function to check for duplicate emails
create or replace function public.is_duplicate_email(
  p_user_id uuid,
  p_type text,
  p_subject text,
  p_window_minutes int default 60
)
returns boolean as $$
begin
  return exists (
    select 1 from public.email_log
    where user_id = p_user_id
    and type = p_type
    and subject = p_subject
    and status in ('sent', 'queued')
    and created_at > now() - (p_window_minutes || ' minutes')::interval
  );
end;
$$ language plpgsql security definer;
```

## Tasks / Subtasks
- [ ] Create migration file for `email_log` table
- [ ] Apply migration to Supabase
- [ ] Create indexes for performance optimization
- [ ] Create RLS policies for admin access
- [ ] Implement duplicate detection function
- [ ] Create helper functions for logging
- [ ] Set up automatic cleanup for old logs (optional)

## Dev Notes
- Consider partitioning table by date for large volumes
- Implement log retention policy (e.g., keep logs for 90 days)
- Use `bigserial` for id to handle high volume
- Store provider_response as JSONB for structured data
- Consider adding `metadata` JSONB field for additional context

## API Functions Needed
```javascript
// Log email attempt
async function logEmailAttempt(data) {
  const { user_id, recipient_email, type, subject, status, error_text, provider_response } = data;
  
  return await supabase
    .from('email_log')
    .insert({
      user_id,
      recipient_email,
      type,
      subject,
      status,
      error_text,
      provider_response,
      attempts: 1
    });
}

// Update email status
async function updateEmailStatus(logId, status, error_text = null, provider_response = null) {
  return await supabase
    .from('email_log')
    .update({
      status,
      error_text,
      provider_response,
      sent_at: status === 'sent' ? new Date().toISOString() : null
    })
    .eq('id', logId);
}

// Check for duplicates
async function checkDuplicateEmail(user_id, type, subject, windowMinutes = 60) {
  const { data } = await supabase
    .rpc('is_duplicate_email', {
      p_user_id: user_id,
      p_type: type,
      p_subject: subject,
      p_window_minutes: windowMinutes
    });
  
  return data;
}
```

## Testing Checklist
- [ ] Email log entry created on send attempt
- [ ] Status updates correctly (queued â†’ sent/failed)
- [ ] Duplicate detection works within time window
- [ ] Admin can view all logs
- [ ] Regular users cannot access logs
- [ ] Indexes improve query performance
- [ ] Failed emails can be retried
