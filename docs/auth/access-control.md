# الوصول والمصادقة (Auth & Access Control)

## حماية الصفحات عبر الخادم (App Router)
- يتم التحقق من جلسة المستخدم في الخادم قبل عرض الصفحة.
- مثال: `app/request-service/page.jsx` يستخدم `supabase.auth.getUser()` ويحول غير المصدقين إلى صفحة الدخول مع مسار العودة:
```
app/request-service/page.jsx:5
redirect('/login?redirect=/request-service')
```

## حماية العميل (Client Guard)
- استخدم `src/components/AuthGuard.tsx` لتقييد الوصول حسب الأدوار داخل مكونات العميل.
- يقود المستخدم إلى صفحة مناسبة أو صفحة الدخول عند عدم التحقق.

## توجيه بعد تسجيل الدخول
- صفحة تسجيل الدخول تقرأ `redirect` أو `from` من الاستعلام وتعيد المستخدم للوجهة المقصودة بعد النجاح.
- تطبيقنا يمرر `redirect=/request-service` لضمان العودة الصحيحة.

## سياسات قاعدة البيانات (Supabase RLS)
- تم تفعيل سياسات RLS للمرفقات والتخزين:
  - السماح للمستخدمين المصدقين برفع الملفات إلى وعاء `attachments`.
  - السماح بإدراج سجلات في جدول `attachments` وعرض مجموعات المستخدم فقط.
- يوصى بتوسيع السياسات لجداول `orders` و`requests` وفق مبدأ “المستخدم يرى ويدرج سجله فقط”.

## توصيات
- إضافة `middleware` لتوجيه غير المصدقين لمسارات محمية، مع الاعتماد الأساسي على التحقق الخادمي.
- نقل عمليات الإنشاء الحساسة إلى RPC أو API خادمي لتجنب تجاوز RLS من الواجهة.

## Middleware
- تم إضافة ملف `middleware.js` في جذر المشروع لحماية المسارات التالية:
  - `/request-service`, `/profile`, `/requests`, `/provider`, `/admin`
- يقوم middleware بقراءة جلسة Supabase وإعادة التوجيه إلى صفحة الدخول مع وسيط `redirect` يحفظ الوجهة الأصلية.
